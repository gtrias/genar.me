---
// Terminal Core Component
// Main terminal container and initialization logic
import '@xterm/xterm/css/xterm.css';
---

<div id="terminal-container" class="terminal-container">
  <div class="loading-message">Initializing system...</div>
  <slot />
</div>

<script>
  import { TerminalManager } from '../terminal/core/TerminalManager';
  import { defaultTerminalConfig } from '../terminal/config/TerminalConfig';

  document.addEventListener('DOMContentLoaded', async () => {
    const container = document.getElementById('terminal-container');
    if (container) {
      try {
        // Clear loading message
        container.innerHTML = '';
        
        // Initialize terminal manager
        const terminal = new TerminalManager(container, defaultTerminalConfig);
        await terminal.initialize();
        await terminal.startBootSequence();
        
        // Store terminal instance globally for cleanup
        window.terminalManager = terminal;
        
      } catch (error) {
        console.error('Failed to initialize terminal:', error);
        container.innerHTML = `<div class="error-message">Failed to initialize terminal: ${error.message}</div>`;
      }
    }
  });

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (window.terminalManager) {
      window.terminalManager.cleanup();
    }
  });
</script>

<style>
  .terminal-container {
    width: 100%;
    height: 100vh;
    background: transparent;
    border-radius: 0;
    padding: 40px;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9998;
    transition: all 0.1s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .terminal-container :global(.xterm) {
    background: #000;
    /* Smooth squircle-like border radius for authentic CRT appearance */
    border-radius: 3% / 2.5%;
    overflow: hidden;
    height: calc(100vh - 80px) !important;
    width: calc(100% - 80px) !important;
    padding: 20px;
    font-size: 18px;
    box-shadow:
      inset 0 0 120px rgba(0, 0, 0, 0.9),
      inset 0 0 40px rgba(0, 0, 0, 0.7),
      0 0 80px rgba(34, 233, 216, 0.3),
      0 0 120px rgba(227, 72, 128, 0.2);
    position: relative;
    transform-style: preserve-3d;
  }

  .loading-message, .error-message {
    color: #00ff00;
    padding: 20px;
    font-family: monospace;
    text-align: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .error-message {
    color: #ff0000;
  }

  .terminal-error {
    color: #ff0000;
    padding: 20px;
    font-family: monospace;
    text-align: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid #ff0000;
    border-radius: 5px;
  }

  :global(.xterm-viewport) {
    background-color: transparent !important;
  }

  :global(.xterm-screen) {
    background-color: transparent !important;
  }

  /* Fullscreen terminal mode */
  .fullscreen-terminal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9998;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .terminal-container {
      padding: 20px;
    }

    .terminal-container :global(.xterm) {
      height: calc(100vh - 40px) !important;
      width: calc(100% - 40px) !important;
      border-radius: 2.5% / 2%;
      padding: 15px;
      font-size: 14px;
    }
  }
</style>