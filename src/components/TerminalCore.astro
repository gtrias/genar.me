---
// Terminal Core Component
// Main terminal container and initialization logic
import '@xterm/xterm/css/xterm.css';
---

<svg height="0" width="0" viewBox="0 0 93.88 76.19" class="clip-path-defs">
  <clipPath id="crtPath" clipPathUnits="objectBoundingBox" transform="scale(0.01065 0.01312)">
    <path d="M47.78.5c11.65,0,38,.92,41.81,4,3.59,3,3.79,22.28,3.79,34.19,0,11.67-.08,27.79-3.53,31.24S60.3,75.69,47.78,75.69c-11.2,0-39.89-1.16-44-5.27S.57,52.42.57,38.73.31,8.56,4,4.88,34.77.5,47.78.5Z" />
  </clipPath>
</svg>

<div id="terminal-container" class="terminal-container">
  <!-- 90s CRT Monitor Housing -->
  <div class="crt-monitor">
    <!-- Monitor Bezel Frame -->
    <div class="crt-bezel">
      <!-- Screen Container -->
      <div class="crt-screen scanlines">
        <div class="screen-content">
          <div class="loading-message">Initializing system...</div>
          <slot />
        </div>
      </div>
      
      <!-- Bottom Control Panel - 80s PC Monitor Style -->
      <div class="crt-controls">
        <!-- Power LED Indicator -->
        <div class="power-led">
          <div class="led-indicator" id="power-led-indicator"></div>
          <span class="led-label">POWER</span>
        </div>
        
        <!-- Power Switch -->
        <input type="checkbox" id="crt-power-switch" checked>
        <label for="crt-power-switch" class="power-switch-label">
          <span>ON/OFF</span>
        </label>
      </div>
    </div>
    
    <!-- Monitor Stand/Base -->
    <div class="crt-stand"></div>
  </div>
</div>

<script>
  import { TerminalManager } from '../terminal/core/TerminalManager';
  import { defaultTerminalConfig } from '../terminal/config/TerminalConfig';

  document.addEventListener('DOMContentLoaded', async () => {
    const container = document.getElementById('terminal-container');
    const screenContent = container?.querySelector('.screen-content');
    
    if (container && screenContent) {
      try {
        // Clear loading message
        const loadingMsg = screenContent.querySelector('.loading-message');
        if (loadingMsg) {
          loadingMsg.remove();
        }
        
        // Initialize terminal manager in the screen-content area
        const terminal = new TerminalManager(screenContent as HTMLElement, defaultTerminalConfig);
        await terminal.initialize();
        await terminal.startBootSequence();
        
        // Store terminal instance globally for cleanup
        window.terminalManager = terminal;
        
        // Power switch functionality
        const powerSwitch = document.getElementById('crt-power-switch') as HTMLInputElement;
        const ledIndicator = document.getElementById('power-led-indicator');
        
        if (powerSwitch && ledIndicator) {
          // Update LED based on initial state
          const updateLED = (isOn: boolean) => {
            if (isOn) {
              ledIndicator.classList.add('active');
            } else {
              ledIndicator.classList.remove('active');
            }
          };
          
          // Initialize power state
          const crtScreen = container.querySelector('.crt-screen');
          if (crtScreen && powerSwitch.checked) {
            crtScreen.classList.add('power-on');
            updateLED(true);
          } else {
            updateLED(false);
          }
          
          powerSwitch.addEventListener('change', (e) => {
            const isOn = (e.target as HTMLInputElement).checked;
            const crtScreen = container.querySelector('.crt-screen');
            
            updateLED(isOn);
            
            if (crtScreen) {
              if (isOn) {
                crtScreen.classList.remove('power-off');
                crtScreen.classList.add('power-on');
              } else {
                crtScreen.classList.remove('power-on');
                crtScreen.classList.add('power-off');
              }
            }
          });
        }
        
      } catch (error) {
        console.error('Failed to initialize terminal:', error);
        if (screenContent) {
          screenContent.innerHTML = `<div class="error-message">Failed to initialize terminal: ${error.message}</div>`;
        }
      }
    }
  });

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (window.terminalManager) {
      window.terminalManager.cleanup();
    }
  });
</script>

<style>
  /* Terminal Container - Background */
  .terminal-container {
    width: 100%;
    /* Background with color above, image in middle, color below */
    background: 
      linear-gradient(to bottom, 
        #b8e9dc 0%,
        #b8e9dc calc(100% - 300px),
        transparent calc(100% - 400px),
        transparent calc(100% - 150px),
        #9f491d calc(100% - 150px)
      ),
      url('/background.png'),
      #9f491d;
    background-size:
      100% 100%,
      100%,
      100% 100%;
    background-position:
      center center,
      center calc(100% - 150px),
      center bottom;
    background-repeat:
      no-repeat,
      repeat-x,
      no-repeat;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    z-index: 9998;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
  }

  /* 90s CRT Monitor Housing */
  .crt-monitor {
    position: relative;
    width: min(90vw, 1200px);
    max-width: 90vw;
    aspect-ratio: 4 / 3;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Monitor Bezel Frame - 80s PC Monitor Style (White/Beige) */
  .crt-bezel {
    position: relative;
    width: 100%;
    height: calc(100% - 10px);
    /* Authentic 80s beige/cream color */
    background: linear-gradient(
      180deg,
      #f5f5f0 0%,
      #e8e8e0 10%,
      #dcdcc8 30%,
      #d0d0b8 50%,
      #d8d8c4 70%,
      #e4e4d4 90%,
      #ededdf 100%
    );
    border-radius: 8px 8px 4px 4px;
    /* Wider border like authentic 80s CRT monitors */
    padding: 40px 45px 90px 45px;
    box-shadow:
      0 10px 40px rgba(0, 0, 0, 0.3),
      0 0 0 2px #c8c8b0,
      0 0 0 4px #b8b8a0;
    border: 1px solid #c0c0a8;
  }

  .clip-path-defs {
    position: absolute;
    width: 0;
    height: 0;
    pointer-events: none;
  }

  /* Bottom Control Panel - 80s PC Monitor Style (Bottom Right) */
  .crt-controls {
    position: absolute;
    bottom: 15px;
    right: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    z-index: 10;
    pointer-events: none;
  }

  .crt-controls * {
    pointer-events: auto;
  }

  /* Power LED Indicator - 80s PC Monitor Style */
  .power-led {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
  }

  .led-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #d0d0b8;
    box-shadow:
      inset 0 0 4px rgba(0, 0, 0, 0.3),
      0 0 0 1px #b8b8a0,
      0 0 0 2px #d0d0b8;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .led-indicator.active {
    background: #ffaa00;
    box-shadow:
      inset 0 0 8px rgba(255, 200, 0, 0.6),
      0 0 10px rgba(255, 170, 0, 0.8),
      0 0 15px rgba(255, 170, 0, 0.4),
      0 0 0 1px #b8b8a0,
      0 0 0 2px #d0d0b8;
    animation: led-pulse 2s ease-in-out infinite;
  }

  .led-label {
    font-family: 'Arial', sans-serif;
    font-size: 9px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: normal;
    white-space: nowrap;
  }

  @keyframes led-pulse {
    0%, 100% {
      opacity: 1;
      box-shadow:
        inset 0 0 8px rgba(255, 200, 0, 0.6),
        0 0 10px rgba(255, 170, 0, 0.8),
        0 0 15px rgba(255, 170, 0, 0.4),
        0 0 0 1px #b8b8a0,
        0 0 0 2px #d0d0b8;
    }
    50% {
      opacity: 0.7;
      box-shadow:
        inset 0 0 8px rgba(255, 200, 0, 0.4),
        0 0 8px rgba(255, 170, 0, 0.6),
        0 0 12px rgba(255, 170, 0, 0.3),
        0 0 0 1px #b8b8a0,
        0 0 0 2px #d0d0b8;
    }
  }

  /* Power Switch - 90s Style */
  #crt-power-switch {
    display: none;
  }

  .power-switch-label {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    background: #d0d0b8;
    background-image: linear-gradient(to bottom, #e0e0cc 0%, #c8c8b0 100%);
    border: 1px solid #b8b8a0;
    border-radius: 12px;
    box-shadow:
      inset 0 1px 2px rgba(255, 255, 255, 0.6),
      inset 0 -1px 2px rgba(0, 0, 0, 0.2),
      0 1px 2px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .power-switch-label:after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 18px;
    height: 18px;
    background: linear-gradient(to bottom, #f0f0e8 0%, #d8d8c4 100%);
    border: 1px solid #c0c0a8;
    border-radius: 50%;
    box-shadow:
      inset 0 1px 2px rgba(255, 255, 255, 0.8),
      inset 0 -1px 2px rgba(0, 0, 0, 0.2),
      0 1px 1px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
  }

  .power-switch-label span {
    position: absolute;
    bottom: -18px;
    left: 50%;
    transform: translateX(-50%);
    font-family: 'Arial', sans-serif;
    font-size: 8px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    font-weight: normal;
  }

  #crt-power-switch:checked + .power-switch-label,
  #crt-power-switch:active + .power-switch-label {
    background-image: linear-gradient(to bottom, #e8e8d8 0%, #d8d8c8 100%);
  }

  #crt-power-switch:checked + .power-switch-label:after {
    background: linear-gradient(to bottom, #4a4 0%, #2a2 100%);
    box-shadow:
      inset 0 1px 2px rgba(255, 255, 255, 0.3),
      inset 0 -1px 2px rgba(0, 0, 0, 0.3),
      0 1px 1px rgba(0, 0, 0, 0.8),
      0 0 8px rgba(0, 255, 0, 0.4);
    transform: translate(26px, 0);
  }

  /* CRT Screen */
  .crt-screen {
    /* Increased bottom padding to account for control panel and prevent text cutoff */
    padding: 45px 35px 80px 35px;
    box-sizing: border-box;
    position: relative;
    width: 100%;
    height: 100%;
    clip-path: url(#crtPath);
    overflow: hidden;
    box-shadow:
      inset 0 0 120px rgba(0, 0, 0, 0.9),
      inset 0 0 40px rgba(0, 0, 0, 0.7);
  }

  .crt-screen.power-off {
    background: #111;
  }

  .crt-screen.power-off .screen-content {
    animation: crt-power-off 0.55s forwards ease-in-out;
  }

  .crt-screen.power-on .screen-content {
    animation: crt-power-on 4s forwards linear;
  }

  /* Screen Content Area - Adjusted for wider bezel and bottom controls */
  .screen-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .screen-content :global(.xterm) {
    font-size: 28px;
    position: relative;
    z-index: 2;
    transform-style: preserve-3d;
    box-sizing: border-box;
    /* Increased bottom padding on mobile to prevent text cutoff */
    padding: 80px 35px 80px 35px;
    /* Ensure terminal is touch-friendly */
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .screen-content :global(.xterm-viewport) {
    /* Ensure viewport doesn't overflow content area */
    overflow-y: auto;
    /* Smooth scrolling on mobile */
    -webkit-overflow-scrolling: touch;
  }

  /* Monitor Stand/Base - Front-facing 80s Style */
  .crt-stand {
    position: relative;
    width: 320px;
    height: 45px;
    margin-top: 28px; /* Space between stand and screen bezel */
    /* Horizontal rectangular base platform - front view */
    /* Same color as crt-bezel - use solid color first to ensure visibility */
    background: linear-gradient(
      180deg,
      #f5f5f0 0%,
      #e8e8e0 10%,
      #dcdcc8 30%,
      #d0d0b8 50%,
      #d8d8c4 70%,
      #e4e4d4 90%,
      #ededdf 100%
    ) !important;
    /* Slightly rounded top edges, sharp bottom */
    border-radius: 8px 8px 0 0;
    box-shadow:
      0 4px 12px rgba(0, 0, 0, 0.25),
      0 2px 6px rgba(0, 0, 0, 0.15),
      inset 0 1px 3px rgba(255, 255, 255, 0.4),
      inset 0 -2px 4px rgba(0, 0, 0, 0.15);
    border: 1px solid #c0c0a8 !important;
    border-bottom: none;
    z-index: 1; /* Ensure it's visible */
  }

  /* Pedestal/post connecting base to monitor */
  .crt-stand::before {
    content: '';
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    width: 140px;
    height: 25px;
    /* Narrower connection post - same color as bezel */
    background: linear-gradient(
      180deg,
      #f5f5f0 0%,
      #e8e8e0 10%,
      #dcdcc8 30%,
      #d0d0b8 50%,
      #d8d8c4 70%,
      #e4e4d4 90%,
      #ededdf 100%
    ) !important;
    /* Sharp angular design - typical 80s pedestal */
    border-radius: 0;
    box-shadow:
      inset 0 2px 4px rgba(0, 0, 0, 0.2),
      0 1px 2px rgba(0, 0, 0, 0.1),
      inset 0 -1px 2px rgba(255, 255, 255, 0.2);
    border: 1px solid #c0c0a8 !important;
    border-bottom: none;
  }

  /* Subtle depth shadow for 3D effect */
  .crt-stand::after {
    content: '';
    position: absolute;
    bottom: -8px;
    left: 0;
    width: 100%;
    height: 8px;
    /* Bottom shadow to show depth from front view */
    background: linear-gradient(
      180deg,
      rgba(0, 0, 0, 0.3) 0%,
      rgba(0, 0, 0, 0.1) 50%,
      transparent 100%
    );
    border-radius: 0 0 8px 8px;
    transform: perspective(200px) rotateX(-5deg);
    transform-origin: top center;
  }

  .loading-message, .error-message {
    color: #00ff00;
    padding: 20px;
    font-family: monospace;
    text-align: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
  }

  .error-message {
    color: #ff0000;
  }

  .terminal-error {
    color: #ff0000;
    padding: 20px;
    font-family: monospace;
    text-align: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid #ff0000;
    border-radius: 5px;
  }

  :global(.xterm-viewport) {
    background-color: transparent !important;
  }

  /* Fullscreen terminal mode */
  .fullscreen-terminal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    z-index: 9998;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .terminal-container {
      padding: 10px 5px;
      align-items: flex-start;
      padding-top: 5px;
    }

    .crt-monitor {
      width: 98vw;
      max-width: 98vw;
      aspect-ratio: 16 / 10; /* More mobile-friendly aspect ratio */
      max-height: calc(100vh - 20px);
    }

    .crt-bezel {
      padding: 12px 10px 55px 10px;
      border-radius: 6px 6px 3px 3px;
      height: calc(100% - 5px);
    }

    .crt-screen {
      padding: 15px 8px 50px 8px;
    }

    .screen-content :global(.xterm) {
      font-size: 16px;
      padding: 15px 8px 15px 8px !important;
      line-height: 1.4;
    }

    .crt-controls {
      bottom: 8px;
      right: 10px;
      gap: 12px;
    }

    .power-led {
      gap: 4px;
    }

    .led-indicator {
      width: 7px;
      height: 7px;
    }

    .led-label {
      font-size: 7px;
    }

    .power-switch-label {
      width: 40px;
      height: 20px;
      top: 10px;
      right: 10px;
    }

    .power-switch-label:after {
      width: 14px;
      height: 14px;
    }

    .power-switch-label span {
      font-size: 7px;
      bottom: -16px;
    }

    #crt-power-switch:checked + .power-switch-label:after {
      transform: translate(20px, 0);
    }

    .crt-stand {
      width: 180px;
      height: 30px;
    }

    .crt-stand::before {
      width: 90px;
      height: 18px;
      top: -18px;
    }

    .crt-stand::after {
      height: 6px;
      bottom: -6px;
    }

    .loading-message, .error-message {
      font-size: 14px;
      padding: 15px;
    }
  }

  /* Extra small screens (very small phones) */
  @media (max-width: 480px) {
    .terminal-container {
      padding: 5px 2px;
      padding-top: 2px;
    }

    .crt-monitor {
      width: 100vw;
      max-width: 100vw;
      aspect-ratio: 16 / 11;
      max-height: calc(100vh - 10px);
    }

    .crt-bezel {
      padding: 8px 6px 45px 6px;
      border-radius: 4px 4px 2px 2px;
    }

    .crt-screen {
      padding: 12px 6px 40px 6px;
    }

    .screen-content :global(.xterm) {
      font-size: 14px;
      padding: 12px 6px 12px 6px !important;
    }

    .crt-controls {
      bottom: 5px;
      right: 6px;
      gap: 8px;
    }

    .power-led {
      gap: 3px;
    }

    .led-indicator {
      width: 6px;
      height: 6px;
    }

    .led-label {
      font-size: 6px;
    }

    .power-switch-label {
      width: 35px;
      height: 18px;
      top: 8px;
      right: 8px;
    }

    .power-switch-label:after {
      width: 12px;
      height: 12px;
    }

    .power-switch-label span {
      font-size: 6px;
      bottom: -14px;
    }

    #crt-power-switch:checked + .power-switch-label:after {
      transform: translate(17px, 0);
    }

    .crt-stand {
      width: 160px;
      height: 25px;
    }

    .crt-stand::before {
      width: 75px;
      height: 15px;
      top: -15px;
    }

    .crt-stand::after {
      height: 5px;
      bottom: -5px;
    }

    .loading-message, .error-message {
      font-size: 12px;
      padding: 10px;
    }
  }
</style>